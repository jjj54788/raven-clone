# Raven Clone Repo Notes

Last updated: 2026-02-15

Base commit (local): `70a9de5` (`feat: add Google Sign-In via Firebase Authentication`)

## What This Repo Is

Full-stack clone of Raven AI Engine:

- Backend: NestJS + Prisma + PostgreSQL + JWT (`backend/`)
- Frontend: Next.js (App Router) + React + Tailwind (`frontend/`)
- AI providers: OpenAI, DeepSeek (OpenAI-compatible), Google Gemini
- Optional web search via Tavily (backend-side prompt injection of results)

## How To Run (Local)

- PostgreSQL: `docker compose up -d` (`docker-compose.yml`)
- Backend (port 3001): see `README.md` and `backend/package.json`
- Frontend (port 3000): see `frontend/package.json`
- One-click scripts: `start.ps1` / `start.bat` (note: has a DB readiness username mismatch; see below)

## High-Level Data Flow

1. User logs in (local email/password or Google Sign-In), receives `accessToken`.
2. Frontend stores token in `localStorage` and sends `Authorization: Bearer <token>` to backend.
3. New chat creates a `Session` via `/api/v1/ask/sessions`.
4. Chat uses `/api/v1/ai/stream-chat` (SSE) or `/api/v1/ai/simple-chat`; backend loads history from DB, calls provider, streams/returns content, then saves messages.

## Database Model (Prisma)

Defined in `backend/prisma/schema.prisma`:

- `User`: `email` unique, `password?`, `provider`, `avatarUrl?`, `credits`
- `Session`: belongs to `User`, auto-titled (`New Chat` -> first message snippet)
- `Message`: belongs to `Session`, stores `role`, `content`, `model?`

See `backend/prisma/ANALYSIS.md` for a migration drift note.

## Top Risks / TODOs (Actionable)

1. **Prisma migration drift**
   - Migration SQL doesn't match current schema; scripts mix `migrate` vs `db push`.
   - Details: `backend/prisma/ANALYSIS.md`
2. **Weak defaults / security posture**
   - Permissive CORS; token in `localStorage`.
   - Details: `backend/ANALYSIS.md`, `frontend/src/lib/ANALYSIS.md`
3. **Dev script mismatch**
   - `start.ps1` checks DB readiness with user `raven`, but docker-compose sets `POSTGRES_USER=postgres`.

## Where To Read First (For Agents)

- Repo overview: `my-code/ANALYSIS.md`
- Target site feature inventory: `my-code/TARGET_SITE_ANALYSIS.md`
- Backend overview: `backend/ANALYSIS.md`
- Frontend overview: `frontend/ANALYSIS.md`
- Module-level notes:
  - Auth: `backend/src/modules/auth/ANALYSIS.md`
  - AI: `backend/src/modules/ai/ANALYSIS.md`
  - Sessions: `backend/src/modules/ask/ANALYSIS.md`
  - Prisma: `backend/src/modules/prisma/ANALYSIS.md`
  - Frontend API: `frontend/src/lib/ANALYSIS.md`

<!-- AUTO-GENERATED:BEGIN -->
## Auto-Generated Snapshot

This section is generated by `scripts/gen-analysis-md.mjs`. Manual edits inside this block will be overwritten.

### Scope
- Directory: `.`

### Detected Routes (NestJS)
- `GET  /api/v1/admin/auth/allowlist` (backend/src/modules/admin/admin.controller.ts)
- `POST /api/v1/admin/auth/allowlist` (backend/src/modules/admin/admin.controller.ts)
- `DELETE /api/v1/admin/auth/allowlist/:id` (backend/src/modules/admin/admin.controller.ts)
- `GET  /api/v1/admin/auth/settings` (backend/src/modules/admin/admin.controller.ts)
- `PATCH /api/v1/admin/auth/settings` (backend/src/modules/admin/admin.controller.ts)
- `GET  /api/v1/admin/users` (backend/src/modules/admin/admin.controller.ts)
- `PATCH /api/v1/admin/users/:id` (backend/src/modules/admin/admin.controller.ts)
- `GET  /api/v1/ai/models` (backend/src/modules/ai/ai.controller.ts)
- `POST /api/v1/ai/simple-chat` (backend/src/modules/ai/ai.controller.ts)
- `POST /api/v1/ai/stream-chat` (backend/src/modules/ai/ai.controller.ts)
- `GET  /api/v1/ask/sessions` (backend/src/modules/ask/ask.controller.ts)
- `POST /api/v1/ask/sessions` (backend/src/modules/ask/ask.controller.ts)
- `DELETE /api/v1/ask/sessions/:id` (backend/src/modules/ask/ask.controller.ts)
- `GET  /api/v1/ask/sessions/:id/messages` (backend/src/modules/ask/ask.controller.ts)
- `POST /api/v1/auth/google` (backend/src/modules/auth/auth.controller.ts)
- `POST /api/v1/auth/login` (backend/src/modules/auth/auth.controller.ts)
- `GET  /api/v1/auth/me` (backend/src/modules/auth/auth.controller.ts)
- `POST /api/v1/auth/register` (backend/src/modules/auth/auth.controller.ts)
- `GET  /api/v1/store/categories` (backend/src/modules/store/store.controller.ts)
- `POST /api/v1/store/custom-items` (backend/src/modules/store/store.controller.ts)
- `DELETE /api/v1/store/custom-items/:id` (backend/src/modules/store/store.controller.ts)
- `GET  /api/v1/store/items` (backend/src/modules/store/store.controller.ts)
- `GET  /api/v1/store/items/:id` (backend/src/modules/store/store.controller.ts)
- `GET  /api/v1/todos/lists` (backend/src/modules/todo/todo.controller.ts)
- `POST /api/v1/todos/lists` (backend/src/modules/todo/todo.controller.ts)
- `DELETE /api/v1/todos/lists/:id` (backend/src/modules/todo/todo.controller.ts)
- `PATCH /api/v1/todos/lists/:id` (backend/src/modules/todo/todo.controller.ts)
- `GET  /api/v1/todos/overview` (backend/src/modules/todo/todo.controller.ts)
- `GET  /api/v1/todos/tasks` (backend/src/modules/todo/todo.controller.ts)
- `POST /api/v1/todos/tasks` (backend/src/modules/todo/todo.controller.ts)
- `DELETE /api/v1/todos/tasks/:id` (backend/src/modules/todo/todo.controller.ts)
- `PATCH /api/v1/todos/tasks/:id` (backend/src/modules/todo/todo.controller.ts)

### File Tree (depth <= 2)
```text
.githooks/
.githooks/pre-commit
.githooks/pre-push
.gitignore
.prettierignore
.prettierrc
AGENTS.md
ANALYSIS.md
backend/
backend/.env.example
backend/ANALYSIS.md
backend/package.json
backend/pnpm-lock.yaml
backend/pnpm-workspace.yaml
backend/prisma/
backend/prisma/ANALYSIS.md
backend/prisma/schema.prisma
backend/prisma/seed.ts
backend/src/
backend/src/app.module.ts
backend/src/main.ts
backend/tsconfig.json
DEV_TODO.md
docker-compose.yml
frontend/
frontend/ANALYSIS.md
frontend/next-env.d.ts
frontend/next.config.js
frontend/package.json
frontend/pnpm-lock.yaml
frontend/postcss.config.js
frontend/src/
frontend/tsconfig.json
README.md
scripts/
scripts/codex-gen-and-review.ps1
scripts/gen-analysis-md.mjs
scripts/gen-analysis-md.ps1
scripts/setup-githooks.ps1
scripts/setup-githooks.sh
start.bat
start.ps1
TARGET_SITE_ANALYSIS.md
```
<!-- AUTO-GENERATED:END -->
