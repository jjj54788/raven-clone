# AI Module Notes

Last updated: 2026-02-15

## Endpoints

Controller: `backend/src/modules/ai/ai.controller.ts`

- `GET  /api/v1/ai/models` (public)
- `POST /api/v1/ai/simple-chat` (JWT required)
- `POST /api/v1/ai/stream-chat` (JWT required; SSE)

Request body fields used:

- `message` (required)
- `model` (optional model id)
- `sessionId` (optional)
- `webSearch` (optional boolean)
- `messages` (optional manual history for `simple-chat`)

## Provider Abstraction

Service: `backend/src/modules/ai/ai.service.ts`

- Models are registered on module init, based on env vars:
  - OpenAI: `OPENAI_API_KEY` via OpenAI SDK (`openai` package)
  - DeepSeek: `DEEPSEEK_API_KEY` via OpenAI SDK with `baseURL=https://api.deepseek.com/v1`
  - Gemini: `GOOGLE_AI_API_KEY` via `fetch` to Generative Language API
- `getDefaultModel()` returns the first registered model.

## Message Flow

- System prompt:
  - Default: includes today's date and instructs replying in the user language.
  - If `webSearch=true`: runs Tavily and injects results into a special system prompt (instructs citation format).
- History:
  - If `sessionId` is present, it loads the last 50 messages from DB and appends them.
  - Otherwise, `simple-chat` can accept `messages[]` in the request body.
- Persistence:
  - If `sessionId` is present, it saves the user+assistant messages.
  - Also updates `Session.updatedAt` and auto-names the session based on the first user message.

## Session Ownership (Fixed)

- `loadSessionHistory(sessionId, userId)` and `saveMessages(sessionId, userId, ...)` verify ownership via `prisma.session.findFirst({ where: { id: sessionId, userId } })`.
- Uses "Session not found" for both missing and non-owned sessions (prevents enumeration).

## Other Notes / Risks

- Debug logging is gated behind `AI_DEBUG=1` and does not print API key prefixes.
- Basic request validation is enforced via DTOs + `ValidationPipe` (message length, UUID sessionId, etc.).
- CORS is globally enabled without restrictions (set in `main.ts`).

## Usage Limits (Small-Group Defaults)

Enforced in `backend/src/modules/ai/ai-usage.service.ts`:

- Rate limiting (per user, fixed 1-minute window):
  - `AI_RATE_LIMIT_PER_MINUTE` (default `30`, `0` disables)
  - `AI_WEBSEARCH_RATE_LIMIT_PER_MINUTE` (default `10`, `0` disables)
- Streaming concurrency (per user):
  - `AI_STREAM_MAX_CONCURRENCY_PER_USER` (default `2`, `0` disables)
- Credits (optional; enabled by default in production):
  - `AI_CREDITS_ENABLED` (default: `true` in production, `false` otherwise)
  - `AI_CREDIT_COST_CHAT` (default `1`)
  - `AI_CREDIT_COST_WEBSEARCH` (default `1`)

<!-- AUTO-GENERATED:BEGIN -->
## Auto-Generated Snapshot

This section is generated by `scripts/gen-analysis-md.mjs`. Manual edits inside this block will be overwritten.

### Scope
- Directory: `backend/src/modules/ai`

### Detected Routes (NestJS)
- `GET  /api/v1/ai/models` (backend/src/modules/ai/ai.controller.ts)
- `POST /api/v1/ai/simple-chat` (backend/src/modules/ai/ai.controller.ts)
- `POST /api/v1/ai/stream-chat` (backend/src/modules/ai/ai.controller.ts)

### File Tree (depth <= 3)
```text
ai-usage.service.ts
ai.controller.ts
ai.module.ts
ai.service.ts
ANALYSIS.md
dto/
dto/chat-message.dto.ts
dto/simple-chat.dto.ts
dto/stream-chat.dto.ts
```
<!-- AUTO-GENERATED:END -->
