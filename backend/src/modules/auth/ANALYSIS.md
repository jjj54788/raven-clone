# Auth Module Notes

Last updated: 2026-02-15

## Endpoints

Controller: `backend/src/modules/auth/auth.controller.ts`

- `POST /api/v1/auth/register` `{ email, name, password }`
- `POST /api/v1/auth/login` `{ email, password }`
- `POST /api/v1/auth/google` `{ idToken }` (Firebase ID token)
- `GET  /api/v1/auth/me` (JWT)

## Implementation Summary

Service: `backend/src/modules/auth/auth.service.ts`

- Password auth:
  - `register`: ensures email unique; stores `bcrypt` hash.
  - `login`: compares password; blocks if the account has no password (Google-only account).
- Invite-only sign-ups (optional):
  - In production, defaults to **invite-only** unless `AUTH_INVITE_ONLY=0`.
  - Allowlist via `AUTH_ALLOWLIST_EMAILS` and/or `AUTH_ALLOWLIST_DOMAINS` (applies only to new accounts).
- JWT:
  - Access token: `expiresIn: 7d`
  - Refresh token: `expiresIn: 30d`
  - Tokens include `{ sub: userId, type }` (`type=access|refresh`).
  - `getUserIdFromRequest` reads `Authorization` header and returns `sub` for **access tokens only**.
- Google Sign-In:
  - `googleLogin` calls `verifyFirebaseToken` (`backend/src/utils/firebase-admin.ts`).
  - Creates user if missing; if user exists with `provider=local`, it flips provider to `google` and sets `avatarUrl`.

## Gaps / Risks

- Refresh token is issued but there is no refresh endpoint, and the frontend stores only `accessToken`.
- No rate limiting / lockout on login attempts.
- No normalization of emails (case/whitespace) and no password policy checks.

## Suggested Improvements

- Add refresh token rotation + endpoint, or remove refresh token entirely to avoid false expectations.
- Add basic rate limiting / lockout on login attempts.

<!-- AUTO-GENERATED:BEGIN -->
## Auto-Generated Snapshot

This section is generated by `scripts/gen-analysis-md.mjs`. Manual edits inside this block will be overwritten.

### Scope
- Directory: `backend/src/modules/auth`

### Detected Routes (NestJS)
- `POST /api/v1/auth/google` (backend/src/modules/auth/auth.controller.ts)
- `POST /api/v1/auth/login` (backend/src/modules/auth/auth.controller.ts)
- `GET  /api/v1/auth/me` (backend/src/modules/auth/auth.controller.ts)
- `POST /api/v1/auth/register` (backend/src/modules/auth/auth.controller.ts)

### File Tree (depth <= 3)
```text
ANALYSIS.md
auth.controller.ts
auth.module.ts
auth.service.ts
dto/
dto/google-login.dto.ts
dto/login.dto.ts
dto/register.dto.ts
```
<!-- AUTO-GENERATED:END -->
