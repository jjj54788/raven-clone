# Backend Notes (NestJS + Prisma)

Last updated: 2026-02-15

## Structure / Entry Points

- App entry: `backend/src/main.ts`
  - Enables CORS with defaults (`app.enableCors()`).
  - Registers `GlobalExceptionFilter`.
- Root module: `backend/src/app.module.ts`
  - Imports: `PrismaModule`, `AuthModule`, `AiModule`, `AskModule`.

## Modules

- Prisma:
  - `backend/src/modules/prisma/prisma.module.ts` (global)
  - `backend/src/modules/prisma/prisma.service.ts` (connect retry loop)
- Auth:
  - `backend/src/modules/auth/*` (register/login/google/me)
  - JWT helper methods live in `AuthService`
- AI:
  - `backend/src/modules/ai/*` (models list, chat, streaming chat, Tavily web search)
- Ask:
  - `backend/src/modules/ask/*` (sessions CRUD and messages list; JWT protected)

## Environment Variables

From `backend/.env.example`:

- `PORT` (default 3001)
- `DATABASE_URL`
- `JWT_SECRET`
- Provider keys (optional): `OPENAI_API_KEY`, `DEEPSEEK_API_KEY`, `GOOGLE_AI_API_KEY`
- Web search (optional): `TAVILY_API_KEY`
- Google Sign-In (optional): `FIREBASE_PROJECT_ID`, `FIREBASE_CLIENT_EMAIL`, `FIREBASE_PRIVATE_KEY`

## API Surface (v1)

- Auth:
  - `POST /api/v1/auth/register`
  - `POST /api/v1/auth/login`
  - `POST /api/v1/auth/google`
  - `GET  /api/v1/auth/me` (JWT)
- AI:
  - `GET  /api/v1/ai/models`
  - `POST /api/v1/ai/simple-chat`
  - `POST /api/v1/ai/stream-chat` (SSE)
- Sessions:
  - `GET    /api/v1/ask/sessions` (JWT)
  - `POST   /api/v1/ask/sessions` (JWT)
  - `GET    /api/v1/ask/sessions/:id/messages` (JWT)
  - `DELETE /api/v1/ask/sessions/:id` (JWT)

## Known Issues / Risks

- **Permissive CORS** via `enableCors()` without allowlist.
- **Prisma migration drift** between `schema.prisma` and migration SQL (see `backend/prisma/ANALYSIS.md`).

<!-- AUTO-GENERATED:BEGIN -->
## Auto-Generated Snapshot

This section is generated by `scripts/gen-analysis-md.mjs`. Manual edits inside this block will be overwritten.

### Scope
- Directory: `backend`

### Detected Routes (NestJS)
- `GET  /api/v1/admin/auth/allowlist` (backend/src/modules/admin/admin.controller.ts)
- `POST /api/v1/admin/auth/allowlist` (backend/src/modules/admin/admin.controller.ts)
- `DELETE /api/v1/admin/auth/allowlist/:id` (backend/src/modules/admin/admin.controller.ts)
- `GET  /api/v1/admin/auth/settings` (backend/src/modules/admin/admin.controller.ts)
- `PATCH /api/v1/admin/auth/settings` (backend/src/modules/admin/admin.controller.ts)
- `GET  /api/v1/admin/users` (backend/src/modules/admin/admin.controller.ts)
- `PATCH /api/v1/admin/users/:id` (backend/src/modules/admin/admin.controller.ts)
- `GET  /api/v1/ai/models` (backend/src/modules/ai/ai.controller.ts)
- `POST /api/v1/ai/simple-chat` (backend/src/modules/ai/ai.controller.ts)
- `POST /api/v1/ai/stream-chat` (backend/src/modules/ai/ai.controller.ts)
- `GET  /api/v1/ask/sessions` (backend/src/modules/ask/ask.controller.ts)
- `POST /api/v1/ask/sessions` (backend/src/modules/ask/ask.controller.ts)
- `DELETE /api/v1/ask/sessions/:id` (backend/src/modules/ask/ask.controller.ts)
- `GET  /api/v1/ask/sessions/:id/messages` (backend/src/modules/ask/ask.controller.ts)
- `POST /api/v1/auth/google` (backend/src/modules/auth/auth.controller.ts)
- `POST /api/v1/auth/login` (backend/src/modules/auth/auth.controller.ts)
- `GET  /api/v1/auth/me` (backend/src/modules/auth/auth.controller.ts)
- `POST /api/v1/auth/register` (backend/src/modules/auth/auth.controller.ts)
- `GET  /api/v1/checkins` (backend/src/modules/checkin/checkin.controller.ts)
- `POST /api/v1/checkins` (backend/src/modules/checkin/checkin.controller.ts)
- `GET  /api/v1/store/categories` (backend/src/modules/store/store.controller.ts)
- `POST /api/v1/store/custom-items` (backend/src/modules/store/store.controller.ts)
- `DELETE /api/v1/store/custom-items/:id` (backend/src/modules/store/store.controller.ts)
- `GET  /api/v1/store/items` (backend/src/modules/store/store.controller.ts)
- `GET  /api/v1/store/items/:id` (backend/src/modules/store/store.controller.ts)
- `GET  /api/v1/todos/lists` (backend/src/modules/todo/todo.controller.ts)
- `POST /api/v1/todos/lists` (backend/src/modules/todo/todo.controller.ts)
- `DELETE /api/v1/todos/lists/:id` (backend/src/modules/todo/todo.controller.ts)
- `PATCH /api/v1/todos/lists/:id` (backend/src/modules/todo/todo.controller.ts)
- `GET  /api/v1/todos/overview` (backend/src/modules/todo/todo.controller.ts)
- `GET  /api/v1/todos/tasks` (backend/src/modules/todo/todo.controller.ts)
- `POST /api/v1/todos/tasks` (backend/src/modules/todo/todo.controller.ts)
- `DELETE /api/v1/todos/tasks/:id` (backend/src/modules/todo/todo.controller.ts)
- `PATCH /api/v1/todos/tasks/:id` (backend/src/modules/todo/todo.controller.ts)

### File Tree (depth <= 3)
```text
.env.example
ANALYSIS.md
package.json
pnpm-lock.yaml
pnpm-workspace.yaml
prisma/
prisma/ANALYSIS.md
prisma/migrations/
prisma/migrations/20260214093058_init/
prisma/migrations/20260214093058_init/migration.sql
prisma/migrations/20260215120000_align_user_schema/
prisma/migrations/20260215120000_align_user_schema/migration.sql
prisma/migrations/20260215153000_add_todo_module/
prisma/migrations/20260215153000_add_todo_module/migration.sql
prisma/migrations/20260215190000_invite_admin_settings/
prisma/migrations/20260215190000_invite_admin_settings/migration.sql
prisma/migrations/20260215203000_add_store_custom_items/
prisma/migrations/20260215203000_add_store_custom_items/migration.sql
prisma/migrations/20260215211000_add_daily_checkins/
prisma/migrations/20260215211000_add_daily_checkins/migration.sql
prisma/migrations/migration_lock.toml
prisma/schema.prisma
prisma/seed.ts
src/
src/app.module.ts
src/common/
src/common/ANALYSIS.md
src/common/decorators/
src/common/decorators/current-user.decorator.ts
src/common/filters/
src/common/filters/http-exception.filter.ts
src/common/guards/
src/common/guards/admin.guard.ts
src/common/guards/jwt-auth.guard.ts
src/main.ts
src/modules/
src/modules/admin/
src/modules/admin/admin.controller.ts
src/modules/admin/admin.module.ts
src/modules/admin/admin.service.ts
src/modules/ai/
src/modules/ai/ai-usage.service.ts
src/modules/ai/ai.controller.ts
src/modules/ai/ai.module.ts
src/modules/ai/ai.service.ts
src/modules/ai/ANALYSIS.md
src/modules/ask/
src/modules/ask/ANALYSIS.md
src/modules/ask/ask.controller.ts
src/modules/ask/ask.module.ts
src/modules/ask/ask.service.ts
src/modules/auth/
src/modules/auth/ANALYSIS.md
src/modules/auth/auth.controller.ts
src/modules/auth/auth.module.ts
src/modules/auth/auth.service.ts
src/modules/checkin/
src/modules/checkin/checkin.controller.ts
src/modules/checkin/checkin.module.ts
src/modules/checkin/checkin.service.ts
src/modules/prisma/
src/modules/prisma/ANALYSIS.md
src/modules/prisma/prisma.module.ts
src/modules/prisma/prisma.service.ts
src/modules/store/
src/modules/store/ANALYSIS.md
src/modules/store/store.controller.ts
src/modules/store/store.data.ts
src/modules/store/store.module.ts
src/modules/store/store.service.ts
src/modules/store/store.types.ts
src/modules/todo/
src/modules/todo/todo.controller.ts
src/modules/todo/todo.module.ts
src/modules/todo/todo.service.ts
src/utils/
src/utils/ANALYSIS.md
src/utils/firebase-admin.ts
tsconfig.json
```
<!-- AUTO-GENERATED:END -->
